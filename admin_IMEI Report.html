<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة الإدارة</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.0/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">لوحة التحكم</h1>
  <form id="searchForm" class="mb-4 flex gap-2">
    <input id="searchImei" placeholder="رقم IMEI" class="px-3 py-2 border rounded w-full" />
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">بحث</button>
  </form>
  <div id="results" class="space-y-2"></div>

  <div class="container auth" id="authView" hidden>
    <div class="card login-card">
      <h2>تسجيل الدخول</h2>
      <p class="muted">أدخل كلمة مرور المدير للوصول للوحة التحكم.</p>
      <form id="loginForm">
        <div class="row">
          <label for="password"><strong>كلمة المرور</strong></label>
          <input id="password" type="password" required />
        </div>
        <div class="actions">
          <button class="primary" type="submit">دخول</button>
        </div>
        <p id="loginMsg" class="msg"></p>
      </form>
    </div>
  </div>

  <div class="container dash" id="dashView" hidden>
    <div class="card">
      <div class="topbar">
        <div class="brand"><span class="logo">🛡️</span><strong>لوحة الإدارة</strong></div>
        <div class="row-inline">
          <label for="search"></label><input id="search" class="search" placeholder="بحث برقم IMEI أو المرجع أو العلامة/الطراز" />
          <button id="refresh" class="secondary">تحديث</button>
          <button id="logout" class="primary" style="background:#ef4444;color:#2b0f12;">خروج</button>
        </div>
      </div>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>المرجع</th>
              <th>IMEI</th>
              <th>الحالة</th>
              <th>الجهاز</th>
              <th>اللون</th>
              <th>التاريخ/الموقع</th>
              <th>اتصال</th>
              <th>عام؟</th>
              <th>إجراء</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="dashMsg" class="msg"></p>
    </div>
  </div>

  <script>
    document.getElementById("searchForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const imei = document.getElementById("searchImei").value.trim();
      const res = await fetch(`/api/check?imei=${encodeURIComponent(imei)}`);
      const json = await res.json();
      const container = document.getElementById("results");
      container.innerHTML = "";
      json.reports.forEach(r => {
        const div = document.createElement("div");
        div.className = "p-2 border rounded bg-white dark:bg-gray-800";
        div.textContent = `${r.status} • ${r.brand} ${r.model} • ${r.color} • ${r.location}`;
        container.appendChild(div);
      });
    });

    const qs = (s,p=document)=>p.querySelector(s);
    const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
    const state = { data: [], filter: "" };

    async function me() {
      const r = await fetch("/api/auth/me", { credentials: "include" });
      return r.json();
    }

    function show(view) {
      qs("#authView").hidden = view !== "auth";
      qs("#dashView").hidden = view !== "dash";
    }

    function render() {
      const body = qs("#tbl tbody");
      body.innerHTML = "";
      const f = state.filter.toLowerCase().trim();
      const rows = state.data.filter(x => {
        if (!f) return true;
        const t = [x.ref, x.imei, x.brand, x.model].map(v => (v||"").toLowerCase()).join(" ");
        return t.includes(f);
      });
      for (const r of rows) {
        const tr = document.createElement("tr");

        const tdRef = document.createElement("td");
        tdRef.textContent = r.ref;
        tr.appendChild(tdRef);

        const tdImei = document.createElement("td");
        tdImei.textContent = r.imei;
        tr.appendChild(tdImei);

        const tdStatus = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "badge " + r.status;
        badge.textContent = r.status;
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        const tdDevice = document.createElement("td");
        tdDevice.textContent = [r.brand, r.model].filter(Boolean).join(" ");
        tr.appendChild(tdDevice);

        const tdColor = document.createElement("td");
        tdColor.textContent = r.color || "";
        tr.appendChild(tdColor);

        const tdLoc = document.createElement("td");
        tdLoc.textContent = [r.lost_date || "", r.location || ""].filter(Boolean).join(" • ");
        tr.appendChild(tdLoc);

        const tdContact = document.createElement("td");
        tdContact.innerHTML = [r.contact_name, r.contact_phone, r.contact_email].filter(Boolean).join("<br>");
        tr.appendChild(tdContact);

        const tdPublic = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = r.is_public === 1;
        tdPublic.appendChild(chk);
        tr.appendChild(tdPublic);

        const tdAct = document.createElement("td");
        const sel = document.createElement("select");
        ["lost","stolen","recovered"].forEach(s=>{
          const o=document.createElement("option");
          o.value=s; o.textContent=s; if(s===r.status) o.selected=true; sel.appendChild(o);
        });
        const btn = document.createElement("button");
        btn.textContent = "حفظ";
        btn.className = "primary";
        btn.style.padding = "6px 10px";
        btn.addEventListener("click", async ()=>{
          const dashMsg = qs("#dashMsg");
          dashMsg.className = "msg";
          dashMsg.textContent = "";
          try {
            const res = await fetch("/api/reports/" + encodeURIComponent(r.ref), {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({
                status: sel.value,
                is_public: chk.checked ? 1 : 0
              })
            });
            const j = await res.json();
            if (!res.ok) throw new Error(j.error || "err");
            dashMsg.classList.add("success");
            dashMsg.textContent = "تم الحفظ.";
            await load();
          } catch (e) {
            dashMsg.classList.add("error");
            dashMsg.textContent = "فشل الحفظ.";
          }
        });

        const wrap = document.createElement("div");
        wrap.className = "row-inline";
        wrap.appendChild(sel);
        wrap.appendChild(btn);
        tdAct.appendChild(wrap);
        tr.appendChild(tdAct);

        body.appendChild(tr);
      }
    }

    async function load() {
      const res = await fetch("/api/reports", { credentials: "include" });
      if (!res.ok) throw new Error("auth");
      state.data = await res.json();
      render();
    }

    // Init
    (async ()=>{
      const status = await me();
      if (status.isAdmin) {
        show("dash");
        load().catch(()=>show("auth"));
      } else {
        show("auth");
      }

      // Login
      qs("#loginForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const msg = qs("#loginMsg");
        msg.className = "msg";
        msg.textContent = "";
        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ password: qs("#password").value })
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.error || "err");
          show("dash");
          await load();
        } catch (err) {
          msg.classList.add("error");
          msg.textContent = "بيانات غير صحيحة أو تم تجاوز عدد المحاولات.";
        }
      });

      // Logout
      qs("#logout").addEventListener("click", async ()=>{
        await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
        show("auth");
      });

      // Search + refresh
      qs("#search").addEventListener("input", (e)=>{ state.filter = e.target.value; render(); });
      qs("#refresh").addEventListener("click", ()=>load());
    })();
  </script>
</body>
</html>
